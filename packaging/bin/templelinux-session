#!/usr/bin/env bash
set -euo pipefail

if [[ -z "${TEMPLEOS_ROOT:-}" ]]; then
  if [[ -f "/usr/share/templelinux/TempleOS/Kernel/FontStd.HC" ]]; then
    export TEMPLEOS_ROOT="/usr/share/templelinux/TempleOS"
  else
    script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    repo_root="$(cd "${script_dir}/../.." && pwd)"
    candidate="${repo_root}/third_party/TempleOS"
    if [[ -f "${candidate}/Kernel/FontStd.HC" ]]; then
      export TEMPLEOS_ROOT="${candidate}"
    fi
  fi
fi

if ! command -v sway >/dev/null 2>&1; then
  echo "templelinux-session: sway not found in PATH" >&2
  exit 127
fi

if ! command -v templeshell >/dev/null 2>&1; then
  echo "templelinux-session: templeshell not found in PATH (try: cargo install --path .)" >&2
  exit 127
fi

runtime_dir="${XDG_RUNTIME_DIR:-/tmp}"
config_path="${runtime_dir}/templelinux-sway.conf"

cat >"${config_path}" <<'EOF'
# TempleLinux session (sway) â€” autogenerated config.
#
# Notes:
# - Workspace 1: TempleShell (fullscreen).
# - Workspace 2: Linux apps by default.
# - Hotkeys:
#   - Super+1: back to Temple
#   - Super+2: Linux workspace
# - TempleShell behavior:
#   - `TEMPLE_AUTO_LINUX_WS=1` auto-switches to the Linux workspace after `open`/`browse`.

xwayland enable

set $mod Mod4
set $ws_temple "1: Temple"
set $ws_linux "2: Linux"

bindsym $mod+1 workspace $ws_temple
bindsym $mod+2 workspace $ws_linux

bindsym $mod+Shift+e exec "swaymsg exit"

# Default all windows to the Linux workspace, except TempleShell.
# (Regex uses a negative lookahead so `templeshell` stays on $ws_temple.)
assign [app_id="^(?!templeshell$).*"] $ws_linux
assign [class=".*"] $ws_linux

assign [app_id="templeshell"] $ws_temple
for_window [app_id="templeshell"] fullscreen enable

workspace $ws_temple
exec_always --no-startup-id env TEMPLE_AUTO_LINUX_WS=1 templeshell
EOF

exec sway --config "${config_path}"
